<!-- templates/home.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê·¸ë‹ˆ ë§ˆì¼“</title>

  <!-- CSRF (ì„¸ì…˜ ê¸°ë°˜ Security) -->
  <meta name="_csrf_parameter" th:content="${_csrf.parameterName}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <meta name="_csrf" th:content="${_csrf.token}" />

  <style>
      /* ========== Theme Tokens ========== */
      :root{
          --bg1:#fff7ed; --bg2:#fde7d8; --bg3:#fae8ff;
          --card:#fffaf5; --ink:#443c33; --muted:#7a6f66;
          --accent1:#f4a261; --accent2:#e76f51;
          --ring:rgba(244,162,97,.35);
          --radius:18px; --shadow:0 20px 45px rgba(68,60,51,.18);
      }

      /* ========== Base ========== */
      *{ box-sizing:border-box }
      html, body{ height:100% }
      body{
          margin:0; color:var(--ink);
          font-family:ui-sans-serif, system-ui, -apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,"Apple SD Gothic Neo";
          background:
                  radial-gradient(1200px 700px at 80% 10%, var(--bg3) 0%, transparent 60%),
                  radial-gradient(900px 600px at 10% 90%, var(--bg2) 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg1), #fff);
          padding:24px;
      }
      .container{ max-width:1080px; margin:0 auto }

      /* ========== Cards & Sections ========== */
      .card{
          background:var(--card);
          border-radius:var(--radius);
          border:1px solid #e6d6c9;
          box-shadow:var(--shadow);
          padding:20px 18px;
          position:relative; overflow:hidden;
          animation:fade .28s ease-out both;
      }
      @keyframes fade{ from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:translateY(0) } }

      /* ========== Header / Brand ========== */
      header{
          display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px;
      }
      .brand{ display:flex; align-items:center; gap:12px }
      .badge{
          width:44px; height:44px; border-radius:14px; flex:none;
          background:conic-gradient(from 210deg, #ffd7ba, #f7b267, #e76f51, #ffd7ba);
          display:grid; place-items:center; color:#fff; font-weight:800; letter-spacing:.4px;
          box-shadow:0 10px 20px rgba(231,111,81,.28);
      }
      h1{ margin:0; font-size:24px; line-height:1.2; letter-spacing:-.2px }
      .pill{
          padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #eadfd6;
          font-size:12px; color:#7b6f66;
      }
      .hint{ color:#6f665d; font-size:12px }

      /* ========== Tabs / Toolbar ========== */
      nav.tabs{ display:flex; gap:8px; margin:10px 0 4px; flex-wrap:wrap }
      .tab{
          padding:10px 14px; border-radius:12px; cursor:pointer; user-select:none;
          background:#fff; border:1px solid #eadfd6; color:#6e6259; font-weight:600;
          transition:filter .15s ease, transform .05s ease;
      }
      .tab:hover{ filter:saturate(1.05) }
      .tab:active{ transform:translateY(1px) }
      .tab.active{
          background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff; border-color:transparent;
          box-shadow:0 10px 20px rgba(231,111,81,.25);
      }

      .toolbar{ display:flex; gap:10px; align-items:center; margin:8px 0 14px }
      .toolbar .input{ flex:1 1 320px; min-width:240px }
      .toolbar select.form-control{ min-width:140px }
      .toolbar .btn{ white-space:nowrap; height:36px; line-height:36px; padding:0 12px }

      /* ========== Controls ========== */
      .input, select{
          width:100%; padding:10px 12px; border-radius:12px; border:1px solid #e8ded5; background:#fff;
          color:var(--ink); outline:none; transition:border-color .15s, box-shadow .15s;
      }
      .input:focus, select:focus{ border-color:#f4a261; box-shadow:0 0 0 6px var(--ring) }

      .btn{
          appearance:none; border:0; cursor:pointer;
          padding:10px 14px; border-radius:12px; color:#fff; font-weight:700;
          background:linear-gradient(135deg, var(--accent1), var(--accent2));
          box-shadow:0 10px 20px rgba(231,111,81,.3), 0 2px 6px rgba(0,0,0,.06);
          transition:transform .05s ease, filter .2s ease;
      }
      .btn:hover{ filter:saturate(1.05) brightness(1.02) }
      .btn:active{ transform:translateY(1px) }
      .btn.muted{ background:linear-gradient(135deg,#b8b8b8,#7d7d7d) }
      .checkout-btn{ min-height:40px; padding:10px 18px; border-radius:10px; font-size:14px }

      /* ========== Products Grid ========== */
      .grid{ display:grid; gap:20px }
      .product{
          position:relative; background:var(--card);
          border:1.5px solid #eadfd6; border-radius:14px; padding:16px;
          box-shadow:0 8px 18px rgba(68,60,51,.08);
          transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      }
      .product:hover{
          transform:translateY(-2px);
          box-shadow:0 16px 36px rgba(68,60,51,.16);
          border-color:#f1c7a1;
      }
      .product h3{ overflow-wrap:anywhere }
      .price{ font-weight:800; position:relative; padding-bottom:6px; margin-bottom:10px }
      .price::after{
          content:""; position:absolute; left:0; right:0; bottom:-6px; height:1px;
          background:linear-gradient(90deg, transparent, #eadfd6, transparent);
      }
      .product-actions{
          display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:center;
      }
      .product-actions .btn{ white-space:nowrap; min-width:118px }
      .product-actions .qty input{ width:100px; text-align:right }

      /* ========== Table (Cart) ========== */
      table{ width:100%; border-collapse:separate; border-spacing:0 8px }
      th, td{ padding:12px 14px; text-align:left; font-size:14px }
      thead th{ color:#7a6f66; font-weight:700 }
      tbody tr{
          background:var(--card); border:1px solid #e6d6c9; border-radius:12px;
          box-shadow:0 10px 24px rgba(68,60,51,.10);
      }
      tbody tr td:first-child{ border-top-left-radius:12px; border-bottom-left-radius:12px }
      tbody tr td:last-child{ border-top-right-radius:12px; border-bottom-right-radius:12px }
      thead th:first-child{ width:56px }
      td:first-child, th:first-child{ text-align:center }
      .qty input{ width:100%; text-align:right }

      /* ì„ íƒ ë°°ì§€/ì¹´íŠ¸ ë±ƒì§€ */
      .cart-link{ position:relative; display:inline-flex; align-items:center }
      .cartbadge{
          position:absolute; top:-6px; right:-10px; min-width:18px; height:18px; padding:0 5px;
          border-radius:999px; font-size:12px; line-height:18px; text-align:center;
          background:#ff5252; color:#fff; transform:scale(1); transition:transform .2s ease;
      }
      .cartbadge.bump{ transform:scale(1.2) }

      /* ========== Sticky Footer (Total Bar) ========== */
      .cart-footer{
          position:fixed; bottom:0; left:0; right:0;
          background:#fff7ed; border-top:1px solid #ddd; padding:16px; z-index:1000;
          backdrop-filter:saturate(1.1) blur(6px);
          box-shadow:0 -8px 24px rgba(68,60,51,.10);
      }
      .cart-footer .container{
          display:flex; justify-content:space-between; align-items:center;
          max-width:960px; margin:0 auto;
      }
      /* ì½˜í…ì¸  ê°€ë¦¼ ë°©ì§€ ê¸°ë³¸ ì—¬ë°± (JSê°€ ë®ì–´ì¨ë„ ë¨) */
      body{ padding-bottom:96px }

      /* ========== Responsive ========== */
      @media (max-width:980px){
          .grid{ grid-template-columns: repeat(2, minmax(0,1fr)) }
          .row{ grid-template-columns:1fr 100px 100px }
      }
      @media (max-width:640px){
          .grid{ grid-template-columns:1fr }
          .row{ grid-template-columns:1fr; gap:8px }
          nav.tabs{ gap:6px }
          thead th:nth-child(2), tbody td:nth-child(2){ display:none } /* ë²ˆí˜¸ ìˆ¨ê¹€(ì˜µì…˜) */
      }

      /* ========== Accessibility (Focus/Motion) ========== */
      .input:focus, select:focus, .checkout-btn:focus-visible{
          outline:none; box-shadow:0 0 0 6px var(--ring);
      }
      input[type="checkbox"]:focus-visible{ outline:2px solid #f4a261; outline-offset:2px }
      @media (prefers-reduced-motion: reduce){
          *{ animation:none !important; transition:none !important }
      }

      /* ========== Dark Mode ========== */
      @media (prefers-color-scheme: dark){
          body{ background:linear-gradient(180deg,#1b1917,#26211d) }
          .card{ background:#201d1a; color:#f1eee9 }
          .product{ background:#201d1a }
          .input, select{ background:#161412; border-color:#39322c; color:#f1eee9 }
          .tab{ background:#161412; border-color:#39322c; color:#d9d4cf }
          thead th{ color:#bfb4a9 }
          tbody tr{ background:#161412; border-color:#3a332d; box-shadow:0 10px 24px rgba(0,0,0,.25) }
          .price{ color:#ffe1c7 }
          .btn{ box-shadow:0 8px 18px rgba(0,0,0,.35) }
          .cart-footer{ background:#1e1b18; border-top-color:#3a332d }
      }

      /* ========== Numeric Inputs (UX polish) ========== */
      input[name="qty"]::-webkit-outer-spin-button,
      input[name="qty"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0 }
      input[name="qty"]{ -moz-appearance:textfield }
    </style>

</head>

<body>
<div class="container">
  <div class="card">
    <header>
      <div class="brand">
        <div class="badge">GM</div>
        <div>
          <h1>ì•ˆë…•í•˜ì„¸ìš”, <span th:text="${#authentication.principal.username}"></span> ë‹˜</h1>
          <div class="hint">ì˜¤ëŠ˜ë„ ë”°ëœ»í•œ ì‡¼í•‘ ë˜ì„¸ìš” ğŸ˜Š</div>
        </div>
      </div>
      <div>
        <span class="pill" sec:authorize="hasRole('USER')">ROLE_USER</span>
        <span class="pill" sec:authorize="hasRole('ADMIN')">ROLE_ADMIN</span>
      </div>
    </header>

    <div style="overflow:auto;">
    <form id="checkoutForm" th:action="@{/orders}" method="post">
      <table>
        <thead>
          <tr>
            <th>
              <label style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="chkAll">
                <span>ì „ì²´</span>
              </label>
            </th>
            <th>ë²ˆí˜¸</th>
            <th>ìƒí’ˆì´ë¦„</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>ê°€ê²©</th>
          </tr>
        </thead>

        <tbody>
          <tr th:each="ci : ${cartItems}" th:attr="data-product-id=${ci.productId}, data-unit-price=${ci.productPrice}">
            <td><input type="checkbox" name="chk" checked></td>
            <td th:text="${ci.idx}">ë²ˆí˜¸</td>
            <td th:text="${ci.productName}">ìƒí’ˆì´ë¦„</td>

            <td class="qty">
              <input th:id="|qty-${ci.productId}|"
                     class="input"
                     type="number"
                     name="qty"
                     min="1"
                     th:value="${ci.quantity != null ? ci.quantity : 1}"/>
            </td>

            <td>
              <!-- ì´ˆê¸° í‘œì‹œëŠ” ì„œë²„ê°’(ci.cartPrice)ë¡œ í•´ë‘ë˜, JSê°€ ê³§ ë®ì–´ì”€ -->
              <span data-role="line-total"
                    th:text="${#numbers.formatInteger(ci.cartPrice,1,'COMMA')}">23,000</span>ì›
            </td>
          </tr>

          <tr th:if="${#lists.isEmpty(cartItems)}">
            <td colspan="5" class="hint">í‘œì‹œí•  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
        </tbody>
      </table>
    </form>
    </div>
  </div>

  <footer class="cart-footer">
    <div class="container">
      <span>ì´ í•©ê³„:</span>
      <strong id="totalPrice" th:text="${#numbers.formatInteger(totalPrice,1,'COMMA')} + 'ì›'">0ì›</strong>
      <button class="checkout-btn" type="submit">ê²°ì œí•˜ê¸°</button>
    </div>
  </footer>
</div>

<script>
    const fmt = new Intl.NumberFormat('ko-KR');

    function clampQty(n) {
        const v = parseInt(n, 10);
        return Number.isFinite(v) ? Math.max(1, v) : 1;
    }

    // í•©ê³„ ì¬ê³„ì‚° (ë‹¨ê°€Ã—ìˆ˜ëŸ‰)
    function recalc() {
        let total = 0;

        document.querySelectorAll('tbody tr[data-unit-price]').forEach(row => {
            const checked = row.querySelector('input[type="checkbox"][name="chk"]')?.checked ?? true;
            if (!checked) return;

            const unit = Number(row.dataset.unitPrice) || 0;
            const qtyInput = row.querySelector('input[name="qty"]');
            const qty = clampQty(qtyInput?.value ?? '1');

            const line = unit * qty;
            total += line;

            const lineSpan = row.querySelector('[data-role="line-total"]');
            if (lineSpan) lineSpan.textContent = fmt.format(line);
        });

        const totalEl = document.getElementById('totalPrice');
        if (totalEl) totalEl.textContent = fmt.format(total) + 'ì›';
    }

    // í–‰ ì²´í¬ë°•ìŠ¤ë“¤ ê°€ì ¸ì˜¤ê¸°
    function rowChecks() {
        return Array.from(document.querySelectorAll('tbody input[type="checkbox"][name="chk"]'));
    }

    // í—¤ë”(ì „ì²´ì„ íƒ) ìƒíƒœ ì—…ë°ì´íŠ¸: ëª¨ë‘ ì²´í¬/ëª¨ë‘ í•´ì œ/ì¼ë¶€ ì²´í¬(indeterminate)
    function updateMasterState() {
        const master = document.getElementById('chkAll');
        const checks = rowChecks();
        if (!master) return;

        if (checks.length === 0) {
            master.checked = false;
            master.indeterminate = false;
            master.disabled = true;   // í–‰ ì—†ì„ ë•Œ ë¹„í™œì„±í™”(ì„ íƒ)

            return;
        }

        master.disabled = false;

        const checkedCount = checks.filter(c => c.checked).length;
        master.checked = checkedCount === checks.length;
        master.indeterminate = checkedCount > 0 && checkedCount < checks.length;
    }

    // ì „ì²´ì„ íƒ í´ë¦­ â†’ ëª¨ë“  í–‰ ì²´í¬ ë™ê¸°í™”
    function bindMasterToggle() {
        const master = document.getElementById('chkAll');
        if (!master) return;
        master.addEventListener('change', () => {
            const checks = rowChecks();
            checks.forEach(c => { c.checked = master.checked; });
            master.indeterminate = false;
            recalc();
        });
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.addEventListener('input', (e) => {
        if (e.target.matches('input[name="qty"]')) {
            recalc();
        }
    });

    document.addEventListener('change', (e) => {
        if (e.target.matches('input[type="checkbox"][name="chk"]')) {
            updateMasterState();
            recalc();
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
        // footer ê°€ë¦¼ ë°©ì§€
        const footer = document.querySelector('.cart-footer');
        if (footer) {
            const h = footer.getBoundingClientRect().height;
            document.body.style.paddingBottom = `${h + 16}px`;
        }

        bindMasterToggle();
        updateMasterState();
        recalc();
    });
</script>