<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>그니마켓 · 장바구니</title>
  <style>
    :root{
      --bg:#fff7ed; --card:#fffaf5; --ink:#2b2b2b; --muted:#6b6b6b;
      --accent:#f4a261; --accent2:#e76f51; --ring:rgba(244,162,97,.35);
      --radius:18px; --shadow:0 16px 40px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#ffffff 40%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif}
    .container{max-width:980px;margin:40px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 18px}

    /* 카드 */
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid #f1e8df}
    .card header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px dashed #efdfd2}
    .badge{width:38px;height:38px;border-radius:50%;display:grid;place-items:center;background:var(--accent);color:white;font-weight:700;box-shadow:inset 0 0 0 2px rgba(255,255,255,.45)}
    .brand{display:flex;align-items:center;gap:12px}
    .hint{font-size:12px;color:var(--muted)}

    /* 리스트 헤더 */
    .toolbar{display:flex;align-items:center;gap:12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:white;cursor:pointer;font-weight:600;box-shadow:0 6px 18px var(--ring)}
    .btn.secondary{background:#222;color:#fff}
    .btn.ghost{background:transparent;color:#222;border:1px solid #e9ded3}
    .btn.danger{background:var(--accent2)}
    .btn:disabled{opacity:.45;cursor:not-allowed}

    /* 그리드 */
    .grid{display:grid;grid-template-columns: 36px 1fr 160px 140px 80px;gap:10px;align-items:center;padding:12px 16px}
    .grid.head{font-size:13px;color:#7a6f66;background:#fff;border-bottom:1px dashed #efdfd2}
    .grid.row{border-bottom:1px dashed #f0e6db}

    .item{display:flex;align-items:center;gap:12px}
    .item .thumb{width:52px;height:52px;border-radius:12px;background:#f7efe7;flex:0 0 auto;border:1px solid #f1e8df}
    .item .name{font-weight:600}

    /* 수량 컨트롤 */
    .qty{display:inline-flex;align-items:center;border:1px solid #ead9c7;border-radius:12px;overflow:hidden}
    .qty input{width:64px;border:0;padding:10px 8px;text-align:center;font-size:14px;outline:none;background:#fff}
    .qty button{width:36px;height:36px;border:0;background:#fff;cursor:pointer;border-left:1px solid #ead9c7}
    .qty button:first-child{border-left:0;border-right:1px solid #ead9c7}

    .price,.line-total{text-align:right;font-variant-numeric:tabular-nums}

    /* 푸터 합계 */
    .footer{display:flex;align-items:center;justify-content:space-between;padding:16px 20px}
    .summary{display:flex;align-items:center;gap:18px}
    .summary .chip{background:#fff;border:1px solid #ead9c7;border-radius:999px;padding:8px 12px;font-weight:700}
    .muted{color:var(--muted)}

    @media (max-width: 720px){
      .grid{grid-template-columns: 28px 1fr 120px 120px 70px}
      .item .thumb{display:none}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <header>
      <div class="brand">
        <div class="badge">GM</div>
        <div>
          <h1>장바구니</h1>
          <div class="hint">수량을 변경하면 라인 합계와 선택 합계가 즉시 갱신됩니다.</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn ghost" id="btnSelectAll">전체선택</button>
        <button class="btn danger" id="btnDelete" disabled>선택 삭제</button>
        <button class="btn secondary" id="btnOrder" disabled>선택 주문</button>
      </div>
    </header>

    <!-- 리스트 헤더 -->
    <div class="grid head">
      <div><input type="checkbox" id="chkAll" /></div>
      <div>상품명</div>
      <div style="text-align:center">수량</div>
      <div class="price">가격</div>
      <div class="line-total">합계</div>
    </div>

    <!-- 폼: 수량 업데이트/삭제/주문 모두 이 폼으로 전송 가능 -->
    <form id="cartForm" th:action="@{/cart}" method="post">
      <div id="cartBody">
        <!-- Row 템플릿 (Thymeleaf) -->
        <div class="grid row" th:each="ci, stat : ${cartItems}"
             th:attr="data-product-id=${ci.productId}, data-unit-price=${ci.unitPrice}">
          <div>
            <input type="checkbox" class="row-chk" name="selectedIds"
                   th:value="${ci.productId}" />
          </div>

          <div class="item">
            <div class="thumb" th:if="${ci.thumbUrl != null}" th:style="|background:url('${ci.thumbUrl}') center/cover, #f7efe7|"></div>
            <div>
              <div class="name" th:text="${ci.productName}">상품명</div>
              <div class="muted" th:text="${#numbers.formatInteger(ci.unitPrice, 3, 'COMMA')} + '원/개'">10,000원/개</div>
            </div>
          </div>

          <div style="text-align:center">
            <div class="qty">
              <button type="button" class="btnMinus" aria-label="수량감소">−</button>
              <input type="number" class="qty-input" min="1" step="1"
                     th:name="|items[${stat.index}].quantity|"
                     th:value="${ci.quantity}" />
              <button type="button" class="btnPlus" aria-label="수량증가">＋</button>
            </div>
            <input type="hidden" th:name="|items[${stat.index}].productId|" th:value="${ci.productId}" />
          </div>

          <div class="price" th:text="${#numbers.formatInteger(ci.unitPrice, 3, 'COMMA')} + '원'">10,000원</div>
          <div class="line-total" data-line-total>—</div>
        </div>
        <!-- // row -->
      </div>

      <!-- 합계/액션 -->
      <div class="footer">
        <div class="summary">
          <span class="chip">선택 상품 수: <b id="selCount">0</b>개</span>
          <span class="chip">선택 합계: <b id="selTotal">0원</b></span>
        </div>
        <div class="toolbar">
          <button class="btn danger" id="btnDelete2" disabled>선택 삭제</button>
          <button class="btn" id="btnOrder2" disabled>선택 주문</button>
        </div>
      </div>

      <!-- 서버 라우팅을 구분하고 싶다면 JS에서 action 변경 또는 hidden 필드로 intent 전송 -->
      <input type="hidden" name="intent" id="intent" value="update" />
    </form>
  </div>
</div>

<script>
(function(){
  const fmt = new Intl.NumberFormat('ko-KR');
  const container = document.getElementById('cartBody');
  const chkAll = document.getElementById('chkAll');
  const btnSelectAll = document.getElementById('btnSelectAll');
  const btnDelete = document.getElementById('btnDelete');
  const btnDelete2 = document.getElementById('btnDelete2');
  const btnOrder = document.getElementById('btnOrder');
  const btnOrder2 = document.getElementById('btnOrder2');
  const selCount = document.getElementById('selCount');
  const selTotal = document.getElementById('selTotal');
  const form = document.getElementById('cartForm');
  const intent = document.getElementById('intent');

  // 유틸: 행에서 필요한 요소 얻기
  function getRowParts(row){
    return {
      unitPrice: Number(row.getAttribute('data-unit-price')) || 0,
      qtyInput: row.querySelector('.qty-input'),
      lineTotal: row.querySelector('[data-line-total]'),
      checkbox: row.querySelector('.row-chk')
    };
  }

  function updateLineTotal(row){
    const { unitPrice, qtyInput, lineTotal } = getRowParts(row);
    const q = Math.max(1, parseInt(qtyInput.value || '1', 10));
    const total = unitPrice * q;
    lineTotal.textContent = fmt.format(total) + '원';
  }

  function updateAllLineTotals(){
    document.querySelectorAll('#cartBody .grid.row').forEach(updateLineTotal);
  }

  function updateSelectionSummary(){
    const rows = Array.from(document.querySelectorAll('#cartBody .grid.row'));
    const selected = rows.filter(r => getRowParts(r).checkbox.checked);
    const count = selected.length;
    const sum = selected.reduce((acc, r) => {
      const { unitPrice, qtyInput } = getRowParts(r);
      const q = Math.max(1, parseInt(qtyInput.value || '1', 10));
      return acc + unitPrice * q;
    }, 0);

    selCount.textContent = count;
    selTotal.textContent = fmt.format(sum) + '원';

    // 액션 버튼 enable/disable
    const enabled = count > 0;
    [btnDelete, btnDelete2, btnOrder, btnOrder2].forEach(b => b.disabled = !enabled);

    // 마스터 체크박스 상태 동기화
    const all = rows.length > 0 && selected.length === rows.length;
    chkAll.checked = all;
    chkAll.indeterminate = !all && selected.length > 0;
  }

  // 초기 계산
  updateAllLineTotals();
  updateSelectionSummary();

  // 수량 변경 핸들러 (입력 및 +/- 버튼)
  container.addEventListener('input', e => {
    if(e.target.classList.contains('qty-input')){
      const row = e.target.closest('.grid.row');
      // 최소값 보정
      e.target.value = String(Math.max(1, parseInt(e.target.value || '1', 10)));
      updateLineTotal(row);
      updateSelectionSummary();
    }
  });
  container.addEventListener('click', e => {
    if(e.target.classList.contains('btnMinus') || e.target.classList.contains('btnPlus')){
      const row = e.target.closest('.grid.row');
      const { qtyInput } = getRowParts(row);
      const cur = Math.max(1, parseInt(qtyInput.value || '1', 10));
      qtyInput.value = String(Math.max(1, cur + (e.target.classList.contains('btnPlus') ? 1 : -1)));
      updateLineTotal(row);
      updateSelectionSummary();
    }
  });

  // 체크박스 선택
  container.addEventListener('change', e => {
    if(e.target.classList.contains('row-chk')){
      updateSelectionSummary();
    }
  });

  // 전체 선택 토글
  function toggleAll(to){
    document.querySelectorAll('.row-chk').forEach(ch => ch.checked = to);
    updateSelectionSummary();
  }
  chkAll.addEventListener('change', () => toggleAll(chkAll.checked));
  btnSelectAll.addEventListener('click', (e) => { e.preventDefault(); toggleAll(true); });

  // 삭제 동작 (DOM 제거 + 서버 전송 형태 모두 지원)
  function submitWithIntent(action){
    // 서버로 보낼 때 intent만 바꾸고 form 제출
    intent.value = action; // 'delete' | 'order' | 'update'
    form.submit();
  }

  function removeSelectedRows(){
    const rows = Array.from(document.querySelectorAll('#cartBody .grid.row'));
    rows.forEach(r => { if(getRowParts(r).checkbox.checked) r.remove(); });
    updateSelectionSummary();
  }

  // 아래 두 가지 중 사용하고 싶은 방식만 사용하세요.
  // 1) 서버 제출 방식 (주석 해제):
  // btnDelete.addEventListener('click', (e)=>{ e.preventDefault(); submitWithIntent('delete'); });
  // btnDelete2.addEventListener('click', (e)=>{ e.preventDefault(); submitWithIntent('delete'); });
  // btnOrder.addEventListener('click', (e)=>{ e.preventDefault(); submitWithIntent('order'); });
  // btnOrder2.addEventListener('click', (e)=>{ e.preventDefault(); submitWithIntent('order'); });

  // 2) 데모용 클라이언트 삭제 (DOM에서 제거):
  btnDelete.addEventListener('click', (e)=>{ e.preventDefault(); removeSelectedRows(); });
  btnDelete2.addEventListener('click', (e)=>{ e.preventDefault(); removeSelectedRows(); });

})();
</script>
</body>
</html>
