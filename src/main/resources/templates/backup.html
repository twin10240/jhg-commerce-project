<!-- templates/order/checkout.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>구매 상세</title>

  <style>
    :root{
      --bg:#fafafa; --ink:#222; --muted:#6b7280; --line:#e5e7eb;
      --card:#ffffff; --ok:#111827; --accent:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif}
    .container{max-width:1100px; margin:24px auto; padding:0 16px}
    .page-title{font-size:24px; font-weight:700; margin:8px 0 16px}
    .hint{font-size:13px; color:var(--muted)}
    .grid{display:grid; gap:16px}
    @media (min-width: 960px){ .grid-2{grid-template-columns: 1fr 380px} }

    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.03)}
    .card > .header{padding:14px 16px; border-bottom:1px solid var(--line); font-weight:600}
    .card > .content{padding:14px 16px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .field{flex:1 1 240px; min-width:220px}
    .label{display:block; font-size:13px; color:var(--muted); margin:6px 0}
    .input, .select, .textarea{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; font-size:14px;
    }
    .toolbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px}
    .btn{appearance:none; border:1px solid var(--ink); background:var(--ok); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    .btn.outline{background:#fff; color:var(--ink)}
    .btn.block{width:100%}
    .table{width:100%; border-collapse:collapse}
    .table th, .table td{padding:12px; border-bottom:1px solid var(--line); vertical-align:middle; text-align:left; font-size:14px}
    .table th{font-size:13px; color:var(--muted); font-weight:600}
    .price, .right{text-align:right}
    .qty-input{width:84px}
    .sum{display:flex; flex-direction:column; gap:8px}
    .sum .line{display:flex; justify-content:space-between; font-size:14px}
    .sum .total{font-size:18px; font-weight:800}
    .note{font-size:12px; color:var(--muted)}
    .img{width:56px; height:56px; border-radius:10px; border:1px solid var(--line); object-fit:cover; background:#fff}
    .chip{display:inline-block; padding:4px 8px; font-size:12px; border:1px solid var(--line); border-radius:999px; color:#374151; background:#fff}
    .section-gap{margin-top:16px}
  </style>
</head>
<body>
<div class="container">
  <div class="page-title">구매 상세</div>
  <div class="hint">회원정보·배송지·결제수단을 확인한 뒤 주문을 완료하세요.</div>

  <!-- 하나의 폼에서 회원/배송/주문/결제 모두 전송 -->
  <form th:action="@{/orders/checkout}" th:object="${checkout}" method="post">
    <!-- CSRF -->
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <div class="grid grid-2 section-gap">
      <!-- 좌측: 정보/아이템 -->
      <div class="grid" style="gap:16px">
        <!-- 1) 회원 기본정보 -->
        <section class="card">
          <div class="header">주문자 정보</div>
          <div class="content">
            <div class="row">
              <div class="field">
                <label class="label">이름</label>
                <input class="input" th:field="*{member.name}" placeholder="이름" />
              </div>
              <div class="field">
                <label class="label">이메일</label>
                <input class="input" th:field="*{member.email}" placeholder="you@example.com" />
              </div>
              <div class="field">
                <label class="label">연락처</label>
                <input class="input" th:field="*{member.phone}" placeholder="010-0000-0000" />
              </div>
            </div>
          </div>
        </section>

        <!-- 2) 배송지 -->
        <section class="card">
          <div class="header">배송지</div>
          <div class="content">
            <div class="row">
              <div class="field">
                <label class="label">도시 (City)</label>
                <input class="input" th:field="*{delivery.city}" placeholder="예) 서울특별시" />
              </div>
              <div class="field">
                <label class="label">도로명 주소 (Street)</label>
                <input class="input" th:field="*{delivery.street}" placeholder="예) 테헤란로 123" />
              </div>
              <div class="field">
                <label class="label">우편번호 (Zipcode)</label>
                <input class="input" th:field="*{delivery.zipcode}" placeholder="예) 06234" />
              </div>
            </div>

            <div style="margin-top:8px">
              <label style="display:flex; align-items:center; gap:8px; font-size:14px">
                <input type="checkbox" th:field="*{shipping.saveAsDefault}"/>
                기본 배송지로 저장
              </label>
            </div>
          </div>
        </section>

        <!-- 3) 주문 상품 목록 (단건/다건 모두 지원) -->
        <section class="card">
          <div class="header">주문 상품</div>
          <div class="content">
            <div class="toolbar">
              <div class="hint" th:if="${#lists.size(checkout.items) == 1}">
                <span class="chip">바로구매</span> 1개 상품
              </div>
              <div class="hint" th:if="${#lists.size(checkout.items) > 1}">
                <span class="chip">장바구니</span>
                총 <b th:text="${#lists.size(checkout.items)}">0</b>개 상품
              </div>
              <a class="btn outline" th:href="@{/cart}">장바구니로 이동</a>
            </div>

            <table class="table">
              <thead>
              <tr>
                <th>상품</th>
                <th>옵션</th>
                <th class="right">가격</th>
                <th class="right">수량</th>
                <th class="right">합계</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="item, iStat : *{items}">
                <!-- 전송용 숨김필드(아이디/옵션/수량) -->
                <input type="hidden" th:field="*{items[__${iStat.index}__].productId}"/>
                <input type="hidden" th:field="*{items[__${iStat.index}__].optionId}"/>

                <td>
                  <div style="display:flex; align-items:center; gap:12px">
                    <img class="img" th:src="${item.thumbnailUrl}" alt=""/>
                    <div>
                      <div style="font-weight:600" th:text="${item.name}">상품명</div>
                      <div class="hint" th:text="${item.sku}">SKU</div>
                    </div>
                  </div>
                </td>
                <td>
                  <div th:text="${item.optionText}">색상/사이즈</div>
                </td>
                <td class="right">
                  <span th:text="${#numbers.formatInteger(item.price,3,'COMMA')}">0</span>원
                </td>
                <td class="right">
                  <input class="input qty-input" type="number" min="1"
                         th:field="*{items[__${iStat.index}__].quantity}"/>
                </td>
                <td class="right">
                  <span th:text="${#numbers.formatInteger(item.price * item.quantity,3,'COMMA')}">0</span>원
                </td>
              </tr>
              </tbody>
            </table>

            <div class="note" style="margin-top:8px">
              수량을 변경하면 합계가 다시 계산됩니다.
            </div>
          </div>
        </section>

        <!-- 4) 요청사항/쿠폰/포인트 (선택) -->
        <section class="card">
          <div class="header">추가 정보</div>
          <div class="content">
            <div class="row">
              <div class="field" style="flex:1 1 100%">
                <label class="label">배송 메모</label>
                <textarea class="textarea" rows="3" th:field="*{shipping.memo}" placeholder="예) 부재 시 경비실에 맡겨주세요."></textarea>
              </div>
              <div class="field">
                <label class="label">쿠폰</label>
                <select class="select" th:field="*{discount.couponId}">
                  <option th:value>선택 안 함</option>
                  <option th:each="c : ${coupons}"
                          th:value="${c.id}"
                          th:text="${c.name + ' (-' + #numbers.formatInteger(c.discountAmount,3,'COMMA') + '원)'}">쿠폰명</option>
                </select>
              </div>
              <div class="field">
                <label class="label">포인트 사용</label>
                <input class="input" type="number" min="0" step="10" th:field="*{discount.usePoints}" placeholder="0" />
                <div class="note" th:if="${availablePoints != null}">
                  사용 가능 포인트: <b th:text="${#numbers.formatInteger(availablePoints,3,'COMMA')}">0</b>P
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- 우측: 결제/요약 -->
      <aside class="grid" style="gap:16px">
        <!-- 합계 -->
        <section class="card">
          <div class="header">결제 금액</div>
          <div class="content sum">
            <div class="line"><span>상품 합계</span><b th:text="${#numbers.formatInteger(summary.itemsTotal,3,'COMMA')}">0</b></div>
            <div class="line"><span>배송비</span><b th:text="${#numbers.formatInteger(summary.shippingFee,3,'COMMA')}">0</b></div>
            <div class="line" th:if="${summary.discountTotal > 0}">
              <span>할인 합계</span><b th:text="'-' + #numbers.formatInteger(summary.discountTotal,3,'COMMA')">0</b>
            </div>
            <div class="line total"><span>총 결제금액</span>
              <b th:text="${#numbers.formatInteger(summary.grandTotal,3,'COMMA')}">0</b>
            </div>
          </div>
        </section>

        <!-- 결제수단 -->
        <section class="card">
          <div class="header">결제 수단</div>
          <div class="content">
            <div style="display:flex; flex-direction:column; gap:10px">
              <label style="display:flex; align-items:center; gap:10px">
                <input type="radio" th:field="*{payment.method}" value="CARD" checked/> 신용/체크카드
              </label>
              <label style="display:flex; align-items:center; gap:10px">
                <input type="radio" th:field="*{payment.method}" value="VBANK"/> 무통장입금(가상계좌)
              </label>
              <label style="display:flex; align-items:center; gap:10px">
                <input type="radio" th:field="*{payment.method}" value="EASY"/> 간편결제(페이)
              </label>
            </div>
            <div class="note" style="margin-top:8px">결제 단계에서 PG 창이 열립니다.</div>
          </div>
        </section>

        <!-- 약관 -->
        <section class="card">
          <div class="content">
            <label style="display:flex; align-items:flex-start; gap:10px">
              <input type="checkbox" th:field="*{agreements.purchase}" required/>
              <span style="font-size:14px">구매 조건 및 개인정보 제3자 제공에 동의합니다.</span>
            </label>
          </div>
        </section>

        <!-- 액션 -->
        <section class="card">
          <div class="content" style="display:flex; flex-direction:column; gap:10px">
            <button type="submit" class="btn block">주문하기</button>
            <a class="btn outline block" th:href="@{/}">계속 쇼핑하기</a>
          </div>
        </section>
      </aside>
    </div>
  </form>
</div>
</body>
</html>