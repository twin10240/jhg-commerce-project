<!-- templates/home.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ê·¸ë‹ˆ ë§ˆì¼“</title>

    <!-- CSRF (ì„¸ì…˜ ê¸°ë°˜ Security) -->
    <!--    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}" />-->
    <!--    <meta name="_csrf_header" th:content="${_csrf.headerName}" />-->
    <!--    <meta name="_csrf" th:content="${_csrf.token}" />-->

    <style>
        :root{
            --bg1:#fff7ed; --bg2:#fde7d8; --bg3:#fae8ff;
            --card:#fffaf5; --ink:#443c33; --muted:#7a6f66;
            --accent1:#f4a261; --accent2:#e76f51;
            --ring:rgba(244,162,97,.35);
            --radius:18px; --shadow:0 20px 45px rgba(68,60,51,.18);
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0; color:var(--ink);
            font-family:ui-sans-serif, system-ui, -apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,"Apple SD Gothic Neo";
            background:
                    radial-gradient(1200px 700px at 80% 10%, var(--bg3) 0%, transparent 60%),
                    radial-gradient(900px 600px at 10% 90%, var(--bg2) 0%, transparent 60%),
                    linear-gradient(180deg, var(--bg1), #fff);
            padding:24px;
        }
        .container{max-width:1080px; margin:0 auto}
        .card{
            background:var(--card); border-radius:var(--radius);
            box-shadow:var(--shadow); padding:20px 18px; position:relative; overflow:hidden;
            animation:fade .3s ease;
        }
        @keyframes fade{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
        header{
            display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px;
        }
        .brand{display:flex; align-items:center; gap:12px}
        .badge{
            width:44px; height:44px; border-radius:14px; flex:none;
            background:conic-gradient(from 210deg, #ffd7ba, #f7b267, #e76f51, #ffd7ba);
            display:grid; place-items:center; color:#fff; font-weight:800; letter-spacing:.4px;
            box-shadow:0 10px 20px rgba(231,111,81,.28);
        }
        h1{margin:0; font-size:22px; letter-spacing:-.2px}
        .pill{
            padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #eadfd6;
            font-size:12px; color:#7b6f66;
        }
        nav.tabs{
            display:flex; gap:8px; margin:10px 0 4px; flex-wrap:wrap;
        }
        .tab{
            padding:10px 14px; border-radius:12px; cursor:pointer; user-select:none;
            background:#fff; border:1px solid #eadfd6; color:#6e6259; font-weight:600;
        }
        .tab.active{
            background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff; border-color:transparent;
            box-shadow:0 10px 20px rgba(231,111,81,.25);
        }

        /* ê³µí†µ UI */
        .btn{
            appearance:none; border:0; cursor:pointer;
            padding:10px 14px; border-radius:12px; color:white; font-weight:700;
            background:linear-gradient(135deg, var(--accent1), var(--accent2));
            box-shadow:0 10px 20px rgba(231,111,81,.3), 0 2px 6px rgba(0,0,0,.06);
            transition:transform .05s ease, filter .2s ease;
        }
        .btn:hover{filter:saturate(1.05) brightness(1.02)}
        .btn:active{transform:translateY(1px)}
        .btn.muted{background:linear-gradient(135deg,#b8b8b8,#7d7d7d)}
        .input, select{
            width:100%; padding:10px 12px; border-radius:12px; border:1px solid #e8ded5; background:#fff;
            color:var(--ink); outline:none; transition:border-color .15s, box-shadow .15s;
        }
        .input:focus, select:focus{border-color:#f4a261; box-shadow:0 0 0 6px var(--ring)}
        .hint{color:var(--muted); font-size:12px}
        table{width:100%; border-collapse:separate; border-spacing:0 8px}
        th,td{padding:10px 12px; text-align:left; font-size:14px}
        thead th{color:#7a6f66; font-weight:700}
        tbody tr{background:#fff; border:1px solid #eadfd6; border-radius:12px}
        tbody tr td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
        tbody tr td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}

        /* ìƒí’ˆ ê·¸ë¦¬ë“œ */
        .grid{
            display:grid; gap:14px;
            grid-template-columns: repeat(3, minmax(0,1fr));
        }
        .product{
            background:#fff; border:1px solid #eadfd6; border-radius:14px; padding:12px;
            display:grid; gap:10px;
        }
        .product h3{margin:0; font-size:16px}
        .price{font-weight:800}
        .row{display:grid; grid-template-columns: 1fr 110px 110px; gap:10px; align-items:center}
        .qty{display:flex; gap:8px; align-items:center}
        .qty input{width:76px; text-align:right}

        /* ë ˆì´ì•„ì›ƒ */
        .section{display:none; margin-top:12px}
        .section.active{display:block}

        @media (max-width:980px){
            .grid{grid-template-columns: repeat(2, minmax(0,1fr))}
            .row{grid-template-columns:1fr 100px 100px}
        }
        @media (max-width:640px){
            .grid{grid-template-columns: 1fr}
            .row{grid-template-columns:1fr; gap:8px}
            nav.tabs{gap:6px}
        }

        /* ë‹¤í¬ ëª¨ë“œ ë³´ì™„ */
        @media (prefers-color-scheme: dark){
            body{background:linear-gradient(180deg,#1b1917,#26211d)}
            .card{background:#201d1a; color:#f1eee9}
            .input, select{background:#161412; border-color:#39322c; color:#f1eee9}
            .tab{background:#161412; border-color:#39322c; color:#d9d4cf}
            thead th{color:#bfb4a9}
            tbody tr{background:#161412; border-color:#39322c}
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <header>
            <div class="brand">
                <div class="badge">GM</div>
                <div>
                    <h1>ì•ˆë…•í•˜ì„¸ìš”, <span th:text="${member.name}"></span> ë‹˜</h1>
                    <div class="hint">ì˜¤ëŠ˜ë„ ë”°ëœ»í•œ ì‡¼í•‘ ë˜ì„¸ìš” ğŸ˜Š</div>
                </div>
            </div>
            <div>
                <!--                <span class="pill" sec:authorize="hasRole('USER')">ROLE_USER</span>-->
                <!--                <span class="pill" sec:authorize="hasRole('ADMIN')">ROLE_ADMIN</span>-->
            </div>
        </header>

        <!-- íƒ­ -->
        <nav class="tabs" id="tabs">
            <button class="tab active" data-target="products">ìƒí’ˆ</button>
            <button class="tab" data-target="orders">ë‚´ ì£¼ë¬¸</button>
            <button class="tab" data-target="inventory" sec:authorize="hasRole('ADMIN')">ì¬ê³ (ê´€ë¦¬ì)</button>
        </nav>

        <!-- ìƒí’ˆ ì„¹ì…˜ -->
        <section id="products" class="section active">
            <div style="display:flex; gap:10px; align-items:center; margin:8px 0 14px;">
                <input class="input" placeholder="ìƒí’ˆ ê²€ìƒ‰..." id="searchInput" oninput="filterProducts()" />
                <a class="btn muted" th:href="@{/logout}">ë¡œê·¸ì•„ì›ƒ</a>
            </div>

            <div class="grid" id="productGrid">
                <!-- ì„œë²„ì—ì„œ products: List<ProductSummary> ì œê³µ ê°€ì • -->
                <article class="product" th:each="p : ${products}">
                    <h3 th:text="${p.name}">í—ˆë‹ˆ ë¼ë–¼</h3>
                    <div class="price"><span th:text="${#numbers.formatInteger(p.price,3,'COMMA')}">6,500</span>ì›</div>
                    <form th:action="@{/orders}" method="post" class="row">
                        <!--                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                        <!-- ê°„ë‹¨íˆ ë‹¨ì¼ í’ˆëª© ì¦‰ì‹œ êµ¬ë§¤: items[0].productId / items[0].qty -->
                        <input type="hidden" name="items[0].productId" th:value="${p.id}" />
                        <div class="qty">
                            <label class="hint" for="qty-[[${p.id}]]">ìˆ˜ëŸ‰</label>
                            <input id="qty-[[${p.id}]]" class="input" type="number" name="items[0].qty" min="1" value="1" />
                        </div>
                        <button class="btn" type="submit">ë°”ë¡œ êµ¬ë§¤</button>
                        <button class="btn muted" type="button" onclick="addToCart(this)" th:attr="data-id=${p.id}" >ì¥ë°”êµ¬ë‹ˆ</button>
                    </form>
                </article>
            </div>
        </section>

        <!-- ë‚´ ì£¼ë¬¸ ì„¹ì…˜ -->
        <section id="orders" class="section">
            <div style="display:flex; align-items:center; justify-content:space-between; margin:6px 2px 12px;">
                <div class="hint">ìµœê·¼ ì£¼ë¬¸ ë‚´ì—­ì…ë‹ˆë‹¤.</div>
                <form th:action="@{/orders/me}" method="get">
                    <button class="btn muted" type="submit">ìƒˆë¡œê³ ì¹¨</button>
                </form>
            </div>

            <div style="overflow:auto;">
                <table>
                    <thead>
                    <tr>
                        <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                        <th>ìƒíƒœ</th>
                        <th>ì£¼ë¬¸ê¸ˆì•¡</th>
                        <th>ì£¼ë¬¸ì¼ì‹œ</th>
                        <th style="width:140px">ì•¡ì…˜</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- ì„œë²„ì—ì„œ orders: List<MyOrderSummary> -->
                    <tr th:each="o : ${orders}">
                        <td th:text="${o.id}">101</td>
                        <td th:text="${o.status}">PAID</td>
                        <td><span th:text="${#numbers.formatInteger(o.totalAmount,3,'COMMA')}">23,000</span>ì›</td>
                        <td th:text="${#temporals.format(o.createdAt,'yyyy-MM-dd HH:mm')}">2025-08-26 10:22</td>
                        <td>
                            <a class="btn muted" th:href="@{|/orders/${o.id}|}">ìƒì„¸</a>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(orders)}">
                        <td colspan="5" class="hint">í‘œì‹œí•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ì¬ê³ (ê´€ë¦¬ì) ì„¹ì…˜ -->
        <section id="inventory" class="section" sec:authorize="hasRole('ADMIN')">
            <div style="display:flex; align-items:center; justify-content:space-between; margin:6px 2px 12px;">
                <div class="hint">ì¬ê³  ì¡°ì • ë° ì…ê³  ì²˜ë¦¬</div>
                <a class="btn muted" th:href="@{/admin/inventory}">ì¬ê³ ì¡°íšŒ</a>
            </div>

            <!-- ì¬ê³  ì¡°ì • -->
            <div class="card" style="padding:14px; margin-bottom:12px;">
                <h2 style="margin:4px 0 12px; font-size:18px;">ì¬ê³  ìˆ˜ë™ ì¡°ì •</h2>
                <form th:action="@{/admin/inventory/adjust}" method="post" style="display:grid; grid-template-columns:2fr 1fr 1fr auto; gap:10px; align-items:end;">
                    <!--                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                    <div>
                        <label class="hint">ìƒí’ˆ</label>
                        <select name="productId" class="input">
                            <option th:each="p : ${products}" th:value="${p.id}" th:text="${p.name}">ìƒí’ˆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="hint">ì¦ê° ìˆ˜ëŸ‰(+/-)</label>
                        <input class="input" type="number" name="delta" step="1" value="1" />
                    </div>
                    <div>
                        <label class="hint">ì‚¬ìœ </label>
                        <input class="input" type="text" name="reason" placeholder="ì •ê¸°ì¡°ì‚¬ / íŒŒì† / ì¡°ì • ë“±" />
                    </div>
                    <button class="btn" type="submit">ì¡°ì •</button>
                </form>
            </div>

            <!-- ë°œì£¼ ìƒì„± -->
            <div class="card" style="padding:14px; margin-bottom:12px;">
                <h2 style="margin:4px 0 12px; font-size:18px;">ë°œì£¼ ìƒì„±</h2>
                <form th:action="@{/admin/purchase-orders}" method="post" style="display:grid; grid-template-columns:2fr 1fr 1fr auto; gap:10px; align-items:end;">
                    <!--                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                    <div>
                        <label class="hint">ìƒí’ˆ</label>
                        <select name="items[0].productId" class="input">
                            <option th:each="p : ${products}" th:value="${p.id}" th:text="${p.name}">ìƒí’ˆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="hint">ìˆ˜ëŸ‰</label>
                        <input class="input" type="number" name="items[0].quantity" min="1" value="10" />
                    </div>
                    <div>
                        <label class="hint">ë©”ëª¨</label>
                        <input class="input" type="text" name="memo" placeholder="ê¸´ê¸‰ ë°œì£¼ ë“±" />
                    </div>
                    <button class="btn" type="submit">ë°œì£¼ ìƒì„±</button>
                </form>
            </div>

            <!-- ì…ê³  ì²˜ë¦¬ -->
            <div class="card" style="padding:14px;">
                <h2 style="margin:4px 0 12px; font-size:18px;">ì…ê³  ì²˜ë¦¬</h2>
                <form th:action="@{/admin/purchase-orders/{id}/receive(id=${poId})}" method="post" style="display:grid; grid-template-columns:2fr auto; gap:10px; align-items:end;">
                    <!--                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                    <div>
                        <label class="hint">PO ë²ˆí˜¸</label>
                        <input class="input" type="number" name="poId" placeholder="ì˜ˆ: 1001" />
                    </div>
                    <button class="btn" type="submit">ì…ê³ </button>
                </form>
                <div class="hint" style="margin-top:8px;">â€» ë‹¤í’ˆëª© PO ì²˜ë¦¬ë¼ë©´ ì„œë²„ì—ì„œ í•´ë‹¹ POì˜ ëª¨ë“  í•­ëª©ì„ ì…ê³  ì²˜ë¦¬í•˜ë„ë¡ êµ¬í˜„.</div>
            </div>
        </section>
    </div>
</div>

<script>
    // íƒ­ ì „í™˜
    (function(){
        const tabs = document.getElementById('tabs');
        const sections = document.querySelectorAll('.section');
        tabs?.addEventListener('click', (e) => {
            const btn = e.target.closest('.tab'); if(!btn) return;
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            btn.classList.add('active');
            const id = btn.dataset.target;
            sections.forEach(s => s.classList.toggle('active', s.id === id));
        });
    })();

    // ìƒí’ˆ ê²€ìƒ‰ í•„í„°(í”„ëŸ°íŠ¸ ê°„ì´)
    function filterProducts() {
        const q = (document.getElementById('searchInput')?.value || '').toLowerCase();
        document.querySelectorAll('#productGrid .product').forEach(card => {
            const name = (card.querySelector('h3')?.textContent || '').toLowerCase();
            card.style.display = name.includes(q) ? '' : 'none';
        });
    }

    // ì¥ë°”êµ¬ë‹ˆ (í† ì´: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì˜ˆì‹œ)
    function addToCart(btn){
        const id = btn.getAttribute('data-id');
        const qtyInput = btn.closest('form').querySelector('input[name="items[0].qty"]');
        const qty = Math.max(1, parseInt(qtyInput?.value || '1', 10));
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const i = cart.findIndex(x => x.productId == id);
        if(i>=0) cart[i].qty += qty; else cart.push({productId:id, qty});
        localStorage.setItem('cart', JSON.stringify(cart));
        btn.textContent = 'ë‹´ê²¼ì–´ìš”!';
        setTimeout(()=>btn.textContent='ì¥ë°”êµ¬ë‹ˆ', 1200);
    }
</script>
</body>
</html>