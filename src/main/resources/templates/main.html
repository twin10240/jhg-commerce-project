<!-- templates/home.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>그니 마켓</title>

    <!-- CSRF (세션 기반 Security) -->
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <meta name="_csrf" th:content="${_csrf.token}" />

    <style>
        :root{
            --bg1:#fff7ed; --bg2:#fde7d8; --bg3:#fae8ff;
            --card:#fffaf5; --ink:#443c33; --muted:#7a6f66;
            --accent1:#f4a261; --accent2:#e76f51;
            --ring:rgba(244,162,97,.35);
            --radius:18px; --shadow:0 20px 45px rgba(68,60,51,.18);
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0; color:var(--ink);
            font-family:ui-sans-serif, system-ui, -apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,"Apple SD Gothic Neo";
            background:
                    radial-gradient(1200px 700px at 80% 10%, var(--bg3) 0%, transparent 60%),
                    radial-gradient(900px 600px at 10% 90%, var(--bg2) 0%, transparent 60%),
                    linear-gradient(180deg, var(--bg1), #fff);
            padding:24px;
        }
        .container{max-width:1080px; margin:0 auto}
        .card{
            background:var(--card); border-radius:var(--radius);
            box-shadow:var(--shadow); padding:20px 18px; position:relative; overflow:hidden;
            animation:fade .3s ease;
        }
        @keyframes fade{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
        header{
            display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px;
        }
        .brand{display:flex; align-items:center; gap:12px}
        .badge{
            width:44px; height:44px; border-radius:14px; flex:none;
            background:conic-gradient(from 210deg, #ffd7ba, #f7b267, #e76f51, #ffd7ba);
            display:grid; place-items:center; color:#fff; font-weight:800; letter-spacing:.4px;
            box-shadow:0 10px 20px rgba(231,111,81,.28);
        }
        h1{margin:0; font-size:22px; letter-spacing:-.2px}
        .pill{
            padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #eadfd6;
            font-size:12px; color:#7b6f66;
        }
        nav.tabs{
            display:flex; gap:8px; margin:10px 0 4px; flex-wrap:wrap;
        }
        .tab{
            padding:10px 14px; border-radius:12px; cursor:pointer; user-select:none;
            background:#fff; border:1px solid #eadfd6; color:#6e6259; font-weight:600;
        }
        .tab.active{
            background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff; border-color:transparent;
            box-shadow:0 10px 20px rgba(231,111,81,.25);
        }

        /* 공통 UI */
        .btn{
            appearance:none; border:0; cursor:pointer;
            padding:10px 14px; border-radius:12px; color:white; font-weight:700;
            background:linear-gradient(135deg, var(--accent1), var(--accent2));
            box-shadow:0 10px 20px rgba(231,111,81,.3), 0 2px 6px rgba(0,0,0,.06);
            transition:transform .05s ease, filter .2s ease;
        }
        .btn:hover{filter:saturate(1.05) brightness(1.02)}
        .btn:active{transform:translateY(1px)}
        .btn.muted{background:linear-gradient(135deg,#b8b8b8,#7d7d7d)}
        .input, select{
            width:100%; padding:10px 12px; border-radius:12px; border:1px solid #e8ded5; background:#fff;
            color:var(--ink); outline:none; transition:border-color .15s, box-shadow .15s;
        }
        .input:focus, select:focus{border-color:#f4a261; box-shadow:0 0 0 6px var(--ring)}
        .hint{color:var(--muted); font-size:12px}
        table{width:100%; border-collapse:separate; border-spacing:0 8px}
        th,td{padding:10px 12px; text-align:left; font-size:14px}
        thead th{color:#7a6f66; font-weight:700}
        /*tbody tr{background:#fff; border:1px solid #eadfd6; border-radius:12px}*/
        tbody tr{background: var(--card); border:1px solid #eadfd6; border-radius:12px}
        tbody tr td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
        tbody tr td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}

        .cart-link { position: relative; display:inline-flex; align-items:center; }
        .cartbadge {
          position:absolute; top:-6px; right:-10px;
          min-width:18px; height:18px; padding:0 5px;
          border-radius:999px; font-size:12px; line-height:18px;
          background:#ff5252; color:#fff; text-align:center;
          transform:scale(1); transition:transform .2s ease;
        }
        .cartbadge.bump { transform:scale(1.2); }

        /* 상품 그리드 */
        /* 상품 카드 간 간격을 조금 더 */
        .grid{ gap:20px; }

        /* 카드 대비/분리감 강화 */
        .product{
            position:relative;
            /*background:linear-gradient(180deg, #fff, #fffdf8); !* 배경 살짝 틴트 *!*/
            background: var(--card);
            border:1.5px solid #eadfd6;            /* 테두리 두께 ↑ */
            border-radius:14px;
            padding:16px;                          /* 내부 여백 ↑ */
            box-shadow:0 8px 18px rgba(68,60,51,.08);
            transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease;
        }

        /* 카드 호버 시 미세 리프트 + 강조 */
        .product:hover{
            transform:translateY(-2px);
            box-shadow:0 14px 30px rgba(68,60,51,.14);
            border-color:#f1c7a1;                  /* accent 톤으로 살짝 강조 */
        }

        /* 제목이 길어도 자연스럽게 줄바꿈 */
        .product h3{ overflow-wrap:anywhere; }

        /* 가격 아래에 은은한 구분선 */
        .price{ position:relative; padding-bottom:6px; margin-bottom:10px; }
        .price::after{
            content:""; position:absolute; left:0; right:0; bottom:-6px; height:1px;
            background:linear-gradient(90deg, transparent, #eadfd6, transparent);
        }

        /* 액션 줄(수량/버튼) 여유 */
        .product-actions{
            display:grid;
            grid-template-columns: 1fr auto auto;
            gap:12px; align-items:center;
        }
        .product-actions .btn{ white-space:nowrap; min-width:118px; }
        .product-actions .qty input{ width:100px; text-align:right; }

        /* (옵션) 왼쪽 얇은 색 띠로 더 또렷하게 구분하고 싶으면 주석 해제
        .product::before{
          content:""; position:absolute; left:0; top:0; bottom:0; width:4px;
          background:linear-gradient(180deg, var(--accent1), var(--accent2));
          opacity:.5; border-top-left-radius:14px; border-bottom-left-radius:14px;
        }
        */

        .price{font-weight:800}
        /* 1) 검색창 + 로그아웃 툴바 */
        .toolbar{display:flex; gap:10px; align-items:center; margin:8px 0 14px;}
        .toolbar .input{flex:1; width:auto; min-width:0;} /* flex에서 100% 대신 flex:1 */
        /* 2) 상품 카드 액션 행 */
        /*.row{display:grid; grid-template-columns: 1fr 110px 110px; gap:10px; align-items:center}*/
        /*.qty{display:flex; gap:8px; align-items:center}*/
        /*.qty input{width:76px; text-align:right}*/
        .row{
            display:grid;
            grid-template-columns: minmax(150px,1fr) 128px 128px; /* 버튼 칼럼 여유 ↑ */
            gap:10px; align-items:center;
        }
        .row .btn{width:100%; white-space:nowrap;}  /* 글자 줄바꿈 방지 + 칼럼 가득 */
        .qty input{width:100%; text-align:right;}   /* qty 필드 칼럼 꽉 차게 */

        /*주문내역*/
        .toolbar .form-inline{
            display:flex;
            align-items:center;
            gap:10px;
            flex-wrap:nowrap; /* 항상 일렬 유지(모바일에선 wrap으로 바꾸고 싶으면 wrap으로) */
        }

        /* 인풋은 가변폭으로 */
        .toolbar .form-inline .input{
            flex: 1 1 320px;
            min-width: 240px;
        }

        /* 셀렉트 최소폭 */
        .toolbar select.form-control{
            min-width: 140px;
        }

        /* 버튼 높이/줄바꿈 방지 */
        .toolbar .form-inline .btn{
            white-space: nowrap;
            height: 36px;
            line-height: 36px;
            padding: 0 12px;
        }

        /* 레이아웃 */
        .section{display:none; margin-top:12px}
        .section.active{display:block}

        @media (max-width:980px){
            .grid{grid-template-columns: repeat(2, minmax(0,1fr))}
            .row{grid-template-columns:1fr 100px 100px}
        }
        @media (max-width:640px){
            .grid{grid-template-columns: 1fr}
            .row{grid-template-columns:1fr; gap:8px}
            nav.tabs{gap:6px}
        }

        /* 다크 모드 보완 */
        @media (prefers-color-scheme: dark){
            body{background:linear-gradient(180deg,#1b1917,#26211d)}
            .card{background:#201d1a; color:#f1eee9}
            .product{ background:#201d1a; }
            .input, select{background:#161412; border-color:#39322c; color:#f1eee9}
            .tab{background:#161412; border-color:#39322c; color:#d9d4cf}
            thead th{color:#bfb4a9}
            /*tbody tr{background:#161412; border-color:#39322c}*/
            tbody tr{ background:#161412; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <header>
            <div class="brand">
                <div class="badge">GM</div>
                <div>
                    <h1>안녕하세요, <span th:text="${#authentication.principal.username}"></span> 님</h1>
                    <div class="hint">오늘도 따뜻한 쇼핑 되세요 😊</div>
                </div>
            </div>
            <div>
                <span class="pill" sec:authorize="hasRole('USER')">ROLE_USER</span>
                <span class="pill" sec:authorize="hasRole('ADMIN')">ROLE_ADMIN</span>

                <a href="/cart" class="cart-link" aria-label="장바구니" sec:authorize="hasRole('USER')">
                    <img src="/images/cart.png" alt="장바구니 아이콘" width="24" height="24">
                    <span id="cartBadge" class="cartbadge" aria-live="polite">0</span>
                </a>
            </div>
        </header>

        <!-- 탭 -->
        <nav class="tabs" id="tabs">
            <button class="tab active" data-target="products">상품</button>
            <button class="tab" data-target="orders">내 주문</button>
            <button class="tab" data-target="inventory" sec:authorize="hasRole('ADMIN')">재고(관리자)</button>
        </nav>

        <!-- 상품 섹션 -->
        <section id="products" class="section active">
            <div class="toolbar">
                <input class="input" placeholder="상품 검색..." id="searchInput" oninput="filterProducts()" />
                <!-- 로그아웃: POST 권장 -->
                <form th:action="@{/logout}" method="post" style="margin:0;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button class="btn muted" type="submit">로그아웃</button>
                </form>
            </div>

            <div class="grid" id="productGrid">
                <article class="product" th:each="p : ${products}">
                    <h3 th:text="${p.name}">허니 라떼</h3>
                    <div class="price">
                        <span th:text="${#numbers.formatInteger(p.price,3,'COMMA')}" name="price">6,500</span>원
                    </div>

                    <form th:action="@{/orders}" method="post" class="product-actions">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                        <!-- 단일 품목 즉시 구매 -->
                        <input type="hidden" name="productId" th:value="${p.id}" />

                        <div class="qty">
                            <label class="hint" th:for="|qty-${p.id}|">수량</label>
                            <input th:id="|qty-${p.id}|" class="input" type="number" name="qty" min="1" value="1" />
                        </div>

                        <button class="btn" type="submit">바로 구매</button>
                        <button class="btn muted" type="button" th:onclick="|addToCart(${p.id})|">장바구니</button>
                    </form>
                </article>
            </div>
        </section>

        <!-- 내 주문 섹션 -->
        <section id="orders" class="section">
            <div style="display:flex; align-items:center; justify-content:space-between; margin:6px 2px 12px;">
                <div class="hint">최근 주문 내역입니다.</div>

                <div class="toolbar">
                    <form th:action="@{/orders/me}" th:object="${searchOption}" method="get" class="form-inline">
                        <input class="input" id="productName" th:field="*{productName}" placeholder="상품 검색..." />

                        <select id="orderStatus" th:field="*{orderStatus}" class="form-control">
                            <option value="">주문상태</option>
                            <option th:each="status : ${T(com.jhg.hgpage.domain.enums.OrderStatus).values()}"
                                    th:value="${status}"
                                    th:text="${status}">option</option>
                        </select>

                        <button class="btn muted" type="submit">새로고침</button>
                    </form>
                </div>
            </div>

            <div style="overflow:auto;">
                <table>
                    <thead>
                    <tr>
                        <th>주문번호</th>
                        <th>상태</th>
                        <th>주문금액</th>
                        <th>주문일시</th>
                        <th style="width:140px">더보기</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 서버에서 orders: List<MyOrderSummary> -->
                    <tr th:each="o : ${orders}">
                        <td th:text="${o.id}">101</td>
                        <td th:text="${o.status}">PAID</td>
                        <td><span th:text="${#numbers.formatInteger(o.totalAmount,3,'COMMA')}">23,000</span>원</td>
                        <td th:text="${#temporals.format(o.createdAt,'yyyy-MM-dd HH:mm')}">2025-08-26 10:22</td>
                        <td>
                            <a class="btn muted" th:href="@{|/orders/${o.id}|}">상세</a>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(orders)}">
                        <td colspan="5" class="hint">표시할 주문이 없습니다.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 재고(관리자) 섹션 -->
        <section id="inventory" class="section" sec:authorize="hasRole('ADMIN')">
            <div style="display:flex; align-items:center; justify-content:space-between; margin:6px 2px 12px;">
                <div class="hint">재고 조정 및 입고 처리</div>
                <a class="btn muted" th:href="@{/admin/inventory}">재고조회</a>
            </div>

            <!-- 재고 조정 -->
            <div class="card" style="padding:14px; margin-bottom:12px;">
                <h2 style="margin:4px 0 12px; font-size:18px;">재고 수동 조정</h2>
                <form th:action="@{/admin/inventory/adjust}" method="post" style="display:grid; grid-template-columns:2fr 1fr 1fr auto; gap:10px; align-items:end;">
                    <!--                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                    <div>
                        <label class="hint">상품</label>
                        <select name="productId" class="input">
                            <option th:each="p : ${products}" th:value="${p.id}" th:text="${p.name}">상품</option>
                        </select>
                    </div>
                    <div>
                        <label class="hint">증감 수량(+/-)</label>
                        <input class="input" type="number" name="delta" step="1" value="1" />
                    </div>
                    <div>
                        <label class="hint">사유</label>
                        <input class="input" type="text" name="reason" placeholder="정기조사 / 파손 / 조정 등" />
                    </div>
                    <button class="btn" type="submit">조정</button>
                </form>
            </div>

            <!-- 발주 생성 -->
            <div class="card" style="padding:14px; margin-bottom:12px;">
                <h2 style="margin:4px 0 12px; font-size:18px;">발주 생성</h2>
                <form th:action="@{/admin/purchase-orders}" method="post" style="display:grid; grid-template-columns:2fr 1fr 1fr auto; gap:10px; align-items:end;">
                    <!--                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                    <div>
                        <label class="hint">상품</label>
                        <select name="items[0].productId" class="input">
                            <option th:each="p : ${products}" th:value="${p.id}" th:text="${p.name}">상품</option>
                        </select>
                    </div>
                    <div>
                        <label class="hint">수량</label>
                        <input class="input" type="number" name="items[0].quantity" min="1" value="10" />
                    </div>
                    <div>
                        <label class="hint">메모</label>
                        <input class="input" type="text" name="memo" placeholder="긴급 발주 등" />
                    </div>
                    <button class="btn" type="submit">발주 생성</button>
                </form>
            </div>

            <!-- 입고 처리 -->
            <div class="card" style="padding:14px;">
                <h2 style="margin:4px 0 12px; font-size:18px;">입고 처리</h2>
                <form th:action="@{/admin/purchase-orders/{id}/receive(id=${poId})}" method="post" style="display:grid; grid-template-columns:2fr auto; gap:10px; align-items:end;">
                    <!--                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />-->
                    <div>
                        <label class="hint">PO 번호</label>
                        <input class="input" type="number" name="poId" placeholder="예: 1001" />
                    </div>
                    <button class="btn" type="submit">입고</button>
                </form>
                <div class="hint" style="margin-top:8px;">※ 다품목 PO 처리라면 서버에서 해당 PO의 모든 항목을 입고 처리하도록 구현.</div>
            </div>
        </section>
    </div>
</div>

<script>
    const badge = document.getElementById('cartBadge');
    const csrf = { token: document.querySelector('meta[name="_csrf"]')?.content,
                   header: document.querySelector('meta[name="_csrf_header"]')?.content };

    function bumpBadge() {
      if (!badge) return;
      badge.classList.remove('bump');
      void badge.offsetWidth;
      badge.classList.add('bump');
    }

    function setCartCount(n) {
      if (!badge) return;
      badge.textContent = n;
      bumpBadge();
      try { localStorage.setItem('cartCount', String(n)); } catch(e){}
    }

    // 초기화: 페이지 로드 시 현재 개수 가져오기
    (async function initCartCount(){
      try {
        const r = await fetch('/api/cart/count', { credentials: 'include' });
        if (r.ok) {
          const { count } = await r.json();
          setCartCount(count ?? 0);
        }
      } catch (e) { /* 무시 */ }
    })();

    // 다른 탭에서 변경되면 동기화(선택)
    window.addEventListener('storage', (e) => {
      if (e.key === 'cartCount' && e.newValue != null) {
        badge.textContent = e.newValue;
        bumpBadge();
      }
    });

    // 담기 버튼에서 호출할 함수(프로토타입용)
    let addLock = false;
    async function addToCart(productId) {
      if (addLock) return;           // 더블클릭 방지
      addLock = true;

      const qtyInput = document.getElementById(`qty-${productId}`);
      const qty = Math.max(1, parseInt(qtyInput?.value ?? '1', 10));

      // Optimistic UI: 일단 +1
      const before = Number(badge.textContent || '0');
      setCartCount(before + qty);

      try {
        const body = JSON.stringify({ productId, qty });
        const opt = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include'
        };

        if (csrf.token && csrf.header) opt.headers[csrf.header] = csrf.token;
        opt.body = body;

        const r = await fetch('/api/cart/items', opt);
        if (!r.ok) throw new Error('failed');
        const data = await r.json();              // {count: 장바구니 전체 수량}
        if (typeof data.count === 'number') setCartCount(data.count);

        alert('장바구니에 담겼어요!');
      } catch (e) {
        // 실패 시 롤백
        setCartCount(before);
        alert('담기에 실패했어요. 잠시 후 다시 시도해 주세요.');
      } finally {
        addLock = false;
      }
    }

    // 탭 전환
    (function(){
        const tabs = document.getElementById('tabs');
        const sections = document.querySelectorAll('.section');
        tabs?.addEventListener('click', (e) => {
            const btn = e.target.closest('.tab'); if(!btn) return;
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            btn.classList.add('active');
            const id = btn.dataset.target;
            sections.forEach(s => s.classList.toggle('active', s.id === id));
        });
    })();

    // 상품 검색 필터(프런트 간이)
    function filterProducts() {
        const q = (document.getElementById('searchInput')?.value || '').toLowerCase();
        document.querySelectorAll('#productGrid .product').forEach(card => {
            const name = (card.querySelector('h3')?.textContent || '').toLowerCase();
            card.style.display = name.includes(q) ? '' : 'none';
        });
    }

//# sourceURL=/html/main.js
</script>
</body>
</html>